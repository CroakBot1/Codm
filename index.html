<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Messenger-Style Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#e5ddd5;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  display:flex;
  justify-content:center;
}

.chat-app{
  width:100%;
  max-width:420px;
  height:100vh;
  background:#fff;
  display:flex;
  flex-direction:column;
}

/* HEADER */
.header{
  background:#0084ff;
  color:#fff;
  padding:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:600;
}
.status{font-size:12px; opacity:.9}

/* LOGIN */
#login{
  padding:20px;
}
#login input{
  width:100%;
  padding:12px;
  margin-bottom:10px;
  border-radius:20px;
  border:1px solid #ccc;
}
#login button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:20px;
  background:#0084ff;
  color:#fff;
}

/* CHAT */
#chat{
  flex:1;
  overflow-y:auto;
  padding:10px;
  background:#f0f0f0;
}

.msg{
  max-width:75%;
  margin:2px 0;
  padding:10px 14px;
  border-radius:18px;
  font-size:14px;
  line-height:1.3;
}

.me{
  background:#0084ff;
  color:#fff;
  margin-left:auto;
  border-bottom-right-radius:4px;
}

.other{
  background:#e4e6eb;
  margin-right:auto;
  border-bottom-left-radius:4px;
}

.username{
  font-size:11px;
  font-weight:600;
  margin-bottom:2px;
}

.meta{
  font-size:10px;
  opacity:.7;
  margin-top:2px;
  text-align:right;
}

/* TYPING */
#typing{
  font-size:12px;
  padding:4px 10px;
  color:#666;
}

/* INPUT */
#inputArea{
  display:flex;
  padding:8px;
  border-top:1px solid #ddd;
}
#inputArea input{
  flex:1;
  padding:10px;
  border-radius:20px;
  border:1px solid #ccc;
}
#inputArea button{
  margin-left:6px;
  padding:10px 14px;
  border:none;
  border-radius:20px;
  background:#0084ff;
  color:#fff;
}
</style>
</head>

<body>

<div class="chat-app">

  <div class="header">
    <div>Messenger Clone</div>
    <div class="status" id="onlineStatus">● Offline</div>
  </div>

  <div id="login">
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>

  <div id="chat"></div>
  <div id="typing"></div>

  <div id="inputArea" style="display:none;">
    <input id="message" placeholder="Aa">
    <button id="send">Send</button>
  </div>

</div>

<script src="https://tunnelling-website.onrender.com/socket.io/socket.io.js"></script>
<script>
const socket = io("https://tunnelling-website.onrender.com");

const loginBox = document.getElementById("login");
const chat = document.getElementById("chat");
const inputArea = document.getElementById("inputArea");
const typingDiv = document.getElementById("typing");
const onlineStatus = document.getElementById("onlineStatus");

let user = localStorage.getItem("user") || "";
let typing = false;
let typingTimeout;

/* AUTO LOGIN */
if(user){
  loginSuccess(user);
}

/* LOGIN */
document.getElementById("loginBtn").onclick = () =>{
  const u = username.value.trim();
  const p = password.value.trim();
  if(!u||!p) return alert("Fill all fields");
  localStorage.setItem("user",u);
  loginSuccess(u);
};

function loginSuccess(u){
  user = u;
  loginBox.style.display="none";
  inputArea.style.display="flex";
  socket.emit("login",u);
}

/* SEND MESSAGE */
send.onclick = sendMessage;
message.onkeydown = e=>{
  if(e.key==="Enter") sendMessage();
  emitTyping();
};

function sendMessage(){
  const text = message.value.trim();
  if(!text) return;
  socket.emit("chatMessage",{user,text,time:Date.now()});
  message.value="";
  socket.emit("stopTyping");
}

/* RECEIVE MESSAGE */
socket.on("chatMessage",msg=>{
  addMessage(msg);
  socket.emit("seen");
});

/* LOAD HISTORY */
socket.on("loadMessages",msgs=>{
  chat.innerHTML="";
  msgs.forEach(addMessage);
});

/* TYPING */
function emitTyping(){
  if(!typing){
    typing=true;
    socket.emit("typing",user);
  }
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>{
    typing=false;
    socket.emit("stopTyping");
  },800);
}

socket.on("typing",u=>{
  if(u!==user) typingDiv.textContent = u+" is typing…";
});
socket.on("stopTyping",()=> typingDiv.textContent="");

/* ONLINE */
socket.on("onlineUsers",list=>{
  onlineStatus.textContent = "● "+list.length+" online";
});

/* MESSAGE UI */
function addMessage(m){
  const div=document.createElement("div");
  div.className="msg "+(m.user===user?"me":"other");

  if(m.user!==user){
    const u=document.createElement("div");
    u.className="username";
    u.textContent=m.user;
    div.appendChild(u);
  }

  div.append(m.text);

  const meta=document.createElement("div");
  meta.className="meta";
  meta.textContent = new Date(m.time).toLocaleTimeString([],{
    hour:"2-digit",minute:"2-digit"
  })+(m.user===user?" ✓":"");
  div.appendChild(meta);

  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}
</script>
</body>
</html>
